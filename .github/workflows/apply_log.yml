name: Apply Log

on:
  workflow_dispatch:
    inputs:
      limit:
        description: "Max number of Not Applied rows to process"
        required: true
        default: "1"

concurrency:
  group: apply-log
  cancel-in-progress: true

jobs:
  run:
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y rclone curl jq tar
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install tectonic (binary)
        shell: bash
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          API_URL="https://api.github.com/repos/tectonic-typesetting/tectonic/releases/latest"
          AUTH_HEADER=()
          if [ -n "${GITHUB_TOKEN:-}" ]; then
            AUTH_HEADER=(-H "Authorization: Bearer ${GITHUB_TOKEN}")
          fi
          RELEASE_JSON=$(curl -fsSL -H "Accept: application/vnd.github+json" "${AUTH_HEADER[@]}" "$API_URL")
          URL=$(printf "%s" "$RELEASE_JSON" | jq -er '[.assets[] | select(.name | test("tectonic-.*x86_64.*linux.*\\.tar\\.gz$|tectonic-x86_64-unknown-linux-gnu\\.tar\\.gz$")) | .browser_download_url][0]')
          mkdir -p /tmp/tectonic && cd /tmp/tectonic
          curl -fsSL "$URL" -o tectonic.tar.gz
          tar -xzf tectonic.tar.gz
          BIN=$(find . -maxdepth 3 -type f -name tectonic | head -n 1)
          test -n "$BIN"
          sudo mv "$BIN" /usr/local/bin/tectonic
          sudo chmod +x /usr/local/bin/tectonic
          tectonic --version


      - name: Configure rclone
        shell: bash
        env:
          RCLONE_CONFIG_CONTENT: ${{ secrets.RCLONE_CONFIG }}
        run: |
          set -euo pipefail
          mkdir -p ~/.config/rclone

          # Write the config safely
          printf "%s" "$RCLONE_CONFIG_CONTENT" > ~/.config/rclone/rclone.conf

          # Get remotes from rclone itself (this cannot return token lines)
          REMOTES="$(rclone --config ~/.config/rclone/rclone.conf listremotes | tr -d '\r')"

          if [[ -z "$REMOTES" ]]; then
            echo "No rclone remotes found. Your RCLONE_CONFIG secret is not a valid rclone.conf (INI) file."
            exit 1
          fi

          REMOTE="$(echo "$REMOTES" | head -n 1 | sed 's/:$//')"

          # Validate remote name before using it (prevents leaking config/token in logs)
          if [[ ! "$REMOTE" =~ ^[0-9A-Za-z_.\ -]+$ ]]; then
            echo "Invalid remote name parsed. Fix your RCLONE_CONFIG formatting."
            exit 1
          fi

          echo "RCLONE_REMOTE=$REMOTE" >> "$GITHUB_ENV"

          # Now safe to use
          rclone --config ~/.config/rclone/rclone.conf about "${REMOTE}:"



      - name: Run pipeline
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_MODEL: gemini-2.5-flash
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DB_ID: ${{ secrets.NOTION_DB_ID }}
          DRIVE_ROOT: ${{ secrets.DRIVE_ROOT }}         # JobApps
          LIMIT: ${{ github.event.inputs.limit || '1' }}
          MODEL_NAME: "none"
          PROMPT_VERSION: "v1"
        run: |
          python -m src.run

      - name: Upload run artifacts
        uses: actions/upload-artifact@v4
        with:
          name: run-artifacts
          path: artifacts/
