name: Job Apply Logger

on:
  workflow_dispatch:
    inputs:
      limit:
        description: "Max number of Not Applied rows to process"
        required: true
        default: "1"

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y rclone curl jq tar
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install tectonic (binary)
        shell: bash
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          API_URL="https://api.github.com/repos/tectonic-typesetting/tectonic/releases/latest"
          AUTH_HEADER=()
          if [ -n "${GITHUB_TOKEN:-}" ]; then
            AUTH_HEADER=(-H "Authorization: Bearer ${GITHUB_TOKEN}")
          fi
          RELEASE_JSON=$(curl -fsSL -H "Accept: application/vnd.github+json" "${AUTH_HEADER[@]}" "$API_URL")
          URL=$(printf "%s" "$RELEASE_JSON" | jq -er '[.assets[] | select(.name | test("tectonic-.*x86_64.*linux.*\\.tar\\.gz$|tectonic-x86_64-unknown-linux-gnu\\.tar\\.gz$")) | .browser_download_url][0]')
          mkdir -p /tmp/tectonic && cd /tmp/tectonic
          curl -fsSL "$URL" -o tectonic.tar.gz
          tar -xzf tectonic.tar.gz
          BIN=$(find . -maxdepth 3 -type f -name tectonic | head -n 1)
          test -n "$BIN"
          sudo mv "$BIN" /usr/local/bin/tectonic
          sudo chmod +x /usr/local/bin/tectonic
          tectonic --version


      - name: Configure rclone
        shell: bash
        env:
          RCLONE_CONFIG_CONTENT: ${{ secrets.RCLONE_CONFIG }}
          RCLONE_REMOTE: ${{ secrets.RCLONE_REMOTE }}
        run: |
          set -euo pipefail
          mkdir -p ~/.config/rclone
          printf "%s" "$RCLONE_CONFIG_CONTENT" > ~/.config/rclone/rclone.conf

          RCLONE_REMOTE_CLEAN="$(printf "%s" "${RCLONE_REMOTE}" | tr -d '\r\n\t' | sed 's/:$//' | xargs)"
          rclone --config ~/.config/rclone/rclone.conf about "${RCLONE_REMOTE_CLEAN}:"



      - name: Run pipeline
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_MODEL: gemini-2.5-flash
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DB_ID: ${{ secrets.NOTION_DB_ID }}
          RCLONE_REMOTE: ${{ secrets.RCLONE_REMOTE }}
          DRIVE_ROOT: ${{ secrets.DRIVE_ROOT }}         # JobApps
          LIMIT: ${{ github.event.inputs.limit }}
          MODEL_NAME: "none"
          PROMPT_VERSION: "v1"
        run: |
          python -m src.run

      - name: Upload run artifacts
        uses: actions/upload-artifact@v4
        with:
          name: run-artifacts
          path: artifacts/
